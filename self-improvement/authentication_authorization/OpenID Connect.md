
OpenID Connect — це розширення OAuth2, яке додає рівень автентифікації. Він дозволяє клієнту не тільки отримувати доступ до ресурсів, але й автентифікувати користувача та отримувати базову інформацію про нього.

#### Основні принципи OpenID Connect

1. **ID Token**: Основна особливість OpenID Connect, яка додає ідентифікацію користувача до процесу авторизації. ID Token — це JSON Web Token (JWT), який містить інформацію про користувача (суб’єкт) і додаток.
2. **UserInfo Endpoint**: Клієнт може зробити запит до UserInfo Endpoint для отримання детальної інформації про користувача (такої як ім'я, електронна пошта).
3. **Scopes**:
    - **openid**: Мінімально потрібний для використання OpenID Connect. Вказує, що клієнт хоче автентифікувати користувача.
    - **profile**, **email**, **address** та інші: Визначають, яку інформацію про користувача клієнт запитує.

#### Як працює OpenID Connect

1. Клієнт відправляє запит авторизації до сервера авторизації, вказуючи scope `openid`.
2. Сервер авторизації автентифікує користувача та повертає код авторизації (в **Authorization Code Flow**), який клієнт може обміняти на ID Token і токен доступу.
3. Клієнт отримує ID Token, який містить інформацію про користувача.
4. Додатково клієнт може звернутися до UserInfo Endpoint для отримання детальної інформації.

### Інтеграція OAuth2 та OpenID Connect з API

1. **Налаштування OAuth2 на сервері**:
    
    - Сервер авторизації повинен бути налаштований для видачі токенів.
    - Налаштуйте допустимі клієнти, дозволені URI для редиректу та дозволені scope.
2. **Аутентифікація клієнта**:
    
    - Клієнт надсилає запит на отримання токена до сервера авторизації.
    - Використовуючи Authorization Code Flow, клієнт перенаправляє користувача на сервер авторизації для автентифікації. Після успішної автентифікації сервер повертає код авторизації, який клієнт обмінює на токен доступу.
3. **Доступ до API з токеном**:
    
    - Клієнт додає токен доступу до заголовка `Authorization` у запитах до API. Це дозволяє серверу ресурсу перевірити токен та надати доступ до даних.
    - При закінченні терміну дії токена клієнт може використовувати refresh token для отримання нового токена доступу.
4. **Використання OpenID Connect для автентифікації**:
    
    - Під час запиту на авторизацію вказуйте scope `openid`, щоб отримати ID Token разом з токеном доступу.
    - ID Token містить інформацію про користувача та може бути використаний для автентифікації у вашій системі.
    - Додаткові дані про користувача можна отримати, надіславши запит до UserInfo Endpoint.

### Приклад потоку Authorization Code Flow з використанням OAuth2 та OpenID Connect

```
1. Користувач на клієнті (вашому додатку) натискає "Увійти за допомогою Google".

3. Клієнт надсилає запит авторизації до сервера авторизації Google із запитом scope `openid`. 

4. Google аутентифікує користувача, показує дозвіл, і якщо користувач погоджується, Google пересилає код авторизації на ваш додаток. 

5. Клієнт надсилає код авторизації на сервер авторизації, щоб отримати токен доступу та ID Token. 

6. Додаток отримує токени і може використовувати ID Token для автентифікації, а токен доступу — для запитів до API.
```
### Коротко про безпеку

OAuth2 та OpenID Connect мають певні вимоги до безпеки:

- Використовуйте `https` для всіх запитів, щоб захистити дані від підслуховування.
- Зберігайте токени безпечно, уникайте збереження в `localStorage` для клієнтських додатків, які можуть бути піддані атакам XSS. Замість цього можна використовувати `HttpOnly` кукі.
- Регулярно оновлюйте токени, використовуючи refresh tokens, щоб зменшити ризик компрометації токенів з тривалим строком дії.